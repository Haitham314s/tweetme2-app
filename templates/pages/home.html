{% extends "base.html" %}

{% block title %}Twitter Feed{% endblock %}

{% block content %}
<div class="row text-center">
  <div class="col">
    <h1>Welcome to Tweets App</h1>
    <span>Powered by DJANGO</span>
  </div>
</div>

<div class="row mb-3">
  <div class="col-10 col-md-4 mx-auto">
    <form id="tweet-create-form" class="form" method="POST" action="/create-tweet">
      {% csrf_token %}
      <input type="hidden" value="/" name="next">
      <textarea class="form-control" name="content" placeholder="Your tweet..."></textarea>

      <button type="submit" class="btn btn-primary">Tweet</button>
    </form>
  </div>
</div>

<div class="row" id="tweets">Loading...</div>
{% endblock %}

{% block script %}
<script>
  function handleTweetFormSubmit(e) {
    e.preventDefault()
    const myForm = event.target
    const myFormData = new FormData(myForm)
    const url = myForm.getAttribute("action")
    const method = myForm.getAttribute("method")

    const xhr = new XMLHttpRequest()
    const responseType = "json"
    xhr.responseType = responseType
    xhr.open(method, url)
    xhr.setRequestHeader("HTTP_X_REQUESTED_WITH", "XMLHttpRequest")
    xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest")

    xhr.onload = function () {
      if (xhr.status === 201) {
        const newTweet = xhr.response
        const newTweetElement = formatTweetElement(newTweet)
      }
    }

    xhr.send(myFormData)
  }

  const tweetCreateForm = document.getElementById("tweet-create-form")
  tweetCreateForm.addEventListener("submit", handleTweetFormSubmit)

  const tweetsContainerElement = document.getElementById("tweets")
  // tweetsElement.innerHTML = "Loading..."

  function loadTweets(tweetsElement) {
    const xhr = new XMLHttpRequest()
    const method = "GET"
    const url = "/tweets"
    const responseType = "json"

    xhr.responseType = responseType
    xhr.open(method, url)
    xhr.onload = function () {
      const serverResponse = xhr.response
      var listedItems = serverResponse.response
      var finalTweetStr = ""
      var i;

      for (i = 0; i < listedItems.length; i++) {
        finalTweetStr += formatTweetElement(listedItems[i])
      }
      tweetsElement.innerHTML = finalTweetStr
    }
    xhr.send()
  }

  loadTweets(tweetsContainerElement)

  function handleLike(tweetId, currentCount) {
    console.log(tweetId, currentCount)
  }

  function LikeBtn(tweet) {
    return `<button class="btn btn-primary btn-sm" onclick="handleLike(${tweet.id}, ${tweet.likes})">${tweet.likes} Likes</button>`
  }
  function formatTweetElement(tweet) {
    return `
      <div class="col col-md-10 mx-auto border rounded py-3 mb-4" id="tweet-${tweet.id}">
        <p>${tweet.content}</p>
        <div class="btn-group">
          ${LikeBtn(tweet)}
        </div>
      </div>
      `
  }
</script>
{% endblock %}